---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header';
import Footer from '../../components/Footer';
import VocabularyList from '../../components/vocabulary/VocabularyList';
import { vocabularyRepo } from '../../lib/repositories/vocabulary';
import topicsData from '../../data/topics.json';

// Get query params
const url = new URL(Astro.request.url);
const page = parseInt(url.searchParams.get('page') || '1');
const letter = url.searchParams.get('letter') || undefined;
const topic = url.searchParams.get('topic') || undefined;
const level = url.searchParams.get('level') || undefined;
const search = url.searchParams.get('search') || undefined;

// Fetch vocabulary data
const { items, total, totalPages } = await vocabularyRepo.getPaginated(page, 20, {
  letter,
  topic,
  level,
  search,
});

// Serialize data for client
const vocabularyData = items.map(item => ({
  ...item,
  audioUrl: item.audioUrl || undefined,
  userAudioUrl: item.userAudioUrl || undefined,
  createdAt: item.createdAt.toISOString(),
  updatedAt: item.updatedAt.toISOString(),
}));
---

<Layout title="Vocabulary">
  <Header client:load />
  <main class="flex-1">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {/* Page Header */}
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-2">
          Vocabulary
        </h1>
        <p class="text-gray-600 dark:text-gray-400">
          Browse {total} IELTS vocabulary words organized by topics and levels
        </p>
      </div>

      {/* Vocabulary List Component */}
      <VocabularyList
        client:load
        initialData={vocabularyData}
        initialPage={page}
        totalPages={totalPages}
        total={total}
        topics={topicsData}
        initialFilters={{
          letter,
          topic,
          level,
          search,
        }}
      />
    </div>
  </main>
  <Footer />
</Layout>
